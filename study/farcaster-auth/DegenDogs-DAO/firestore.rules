rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isNumber(value) {
      return value is int || value is float;
    }

    function isValidPost(data) {
      return data.keys().hasOnly([
        "title",
        "body",
        "fid",
        "username",
        "displayName",
        "pfpUrl",
        "createdAt",
        "approvePower",
        "denyPower",
        "threadCount",
        "uid"
      ]) &&
      data.title is string &&
      data.title.size() > 0 &&
      data.title.size() <= 120 &&
      data.body is string &&
      data.body.size() > 0 &&
      data.body.size() <= 1200 &&
      data.fid is int &&
      isNumber(data.approvePower) &&
      data.approvePower >= 0 &&
      isNumber(data.denyPower) &&
      data.denyPower >= 0 &&
      isNumber(data.threadCount) &&
      data.threadCount >= 0 &&
      data.uid == request.auth.uid &&
      data.createdAt is timestamp &&
      (!("username" in data) || data.username is string) &&
      (!("displayName" in data) || data.displayName is string) &&
      (!("pfpUrl" in data) || data.pfpUrl is string);
    }

    function baseApprovePower() {
      return isNumber(resource.data.approvePower) ? resource.data.approvePower : 0;
    }

    function baseDenyPower() {
      return isNumber(resource.data.denyPower) ? resource.data.denyPower : 0;
    }

    function baseThreadCount() {
      return isNumber(resource.data.threadCount) ? resource.data.threadCount : 0;
    }

    function isApproveIncrement() {
      return (request.writeFields.hasOnly(["approvePower"]) ||
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["approvePower"])) &&
        isNumber(request.resource.data.approvePower) &&
        request.resource.data.approvePower > baseApprovePower();
    }

    function isDenyIncrement() {
      return (request.writeFields.hasOnly(["denyPower"]) ||
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["denyPower"])) &&
        isNumber(request.resource.data.denyPower) &&
        request.resource.data.denyPower > baseDenyPower();
    }

    function isThreadIncrement() {
      return (request.writeFields.hasOnly(["threadCount"]) ||
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["threadCount"])) &&
        isNumber(request.resource.data.threadCount) &&
        request.resource.data.threadCount > baseThreadCount();
    }

    function isValidThread(data) {
      return data.keys().hasOnly([
        "body",
        "fid",
        "uid",
        "username",
        "displayName",
        "pfpUrl",
        "createdAt"
      ]) &&
      data.body is string &&
      data.body.size() > 0 &&
      data.body.size() <= 800 &&
      data.fid is int &&
      data.uid == request.auth.uid &&
      data.createdAt is timestamp &&
      (!("username" in data) || data.username is string) &&
      (!("displayName" in data) || data.displayName is string) &&
      (!("pfpUrl" in data) || data.pfpUrl is string);
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if isSignedIn() && isValidPost(request.resource.data);      
      allow update: if isSignedIn() && (
        isApproveIncrement() ||
        isDenyIncrement() ||
        isThreadIncrement()
      );
      allow delete: if false;

      match /votes/{voteId} {
        allow read: if true;
        allow create: if isSignedIn() &&
          request.resource.data.keys().hasOnly([
            "fid",
            "uid",
            "direction",
            "power",
            "weekKey",
            "createdAt"
          ]) &&
          request.resource.data.uid == request.auth.uid &&
          request.resource.data.fid is int &&
          request.resource.data.direction in ["approve", "deny"] &&
          isNumber(request.resource.data.power) &&
          request.resource.data.power > 0 &&
          request.resource.data.weekKey is string &&
          request.resource.data.createdAt is timestamp;
        allow update, delete: if false;
      }

      match /threads/{threadId} {
        allow read: if true;
        allow create: if isSignedIn() && isValidThread(request.resource.data);
        allow update, delete: if false;
      }
    }
  }
}
